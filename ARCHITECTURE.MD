# ğŸ›ï¸ MythWeaver Architecture

**Version:** 0.1.0
**Updated:** November 2025
**Purpose:** Technical architecture reference for judges, contributors, and MCP integrators.

MythWeaver is a **multimodal, agentic storytelling system** powered by a **custom Narrative Engine MCP server**, Gemini Vision for scene understanding, Modal GPUs for map generation, and Claude Sonnet for orchestration.

This document details the internal components, data flows, and system interactions.

---

# âš™ï¸ High-Level System Diagram

```
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚        User (Gradio UI)       â”‚
                       â”‚  - Text input                 â”‚
                       â”‚  - Image uploads (maps)       â”‚
                       â”‚  - Quest selection            â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚          Orchestrator (Claude)     â”‚
                      â”‚  - Multi-step planning              â”‚
                      â”‚  - Tool routing via MCP             â”‚
                      â”‚  - Narrative generation             â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                             MCP Layer                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                   â”‚
                        â”‚                   â”‚
                        â”‚                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     â­ Narrative Engine       â”‚    â”‚      â”‚     Gemini Vision     â”‚
        â”‚         MCP Server           â”‚    â”‚      â”‚   (Google)            â”‚
        â”‚  - generate_objectives()     â”‚    â”‚      â”‚ - Sketch â†’ scene graph â”‚
        â”‚  - analyze_opportunities()   â”‚    â”‚      â”‚ - Entities, layout     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                   â”‚                      â”‚
                        â”‚                   â”‚                      â”‚
                        â”‚                   â”‚                      â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
       â”‚         World State & Memory Store                         â”‚
       â”‚  - Locations, NPCs, relationships                          â”‚
       â”‚  - Quest history                                           â”‚
       â”‚  - Scene graph store                                       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                           Modal GPU                            â”‚
      â”‚          (FLUX.1 / SDXL Map Generator MCP Client)             â”‚
      â”‚    - scene_graph â†’ styled fantasy map (PNG)                   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚            Gradio Output              â”‚
                       â”‚ - Story text                         â”‚
                       â”‚ - Generated maps                     â”‚
                       â”‚ - Quest options                      â”‚
                       â”‚ - (Optional) Audio narration         â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# ğŸ§© Component Breakdown

## 1. Gradio UI (`app.py`)

**Role:** User interface + session container
**Key Features:**

* Multimodal textbox (text + images)
* Chat history
* Quest selection buttons
* Map viewer
* Audio playback (optional)
* Mobile-friendly layout
* Integrates `gr.State` for world persistence

---

## 2. Orchestrator (Claude Sonnet)

**Role:** Brain of the system
**Responsibilities:**

* Reads user input + world state
* Decides which tools to call
* Generates story text
* Chains narrative + map generation
* Maintains thematic consistency

---

## 3. **Narrative Engine MCP Server** (â­ core innovation)

Directory: `mcp_servers/narrative_engine/`

### Tools Provided:

1. **`generate_narrative_objectives(context, style, difficulty, count)`**

   * Produces structured, goal-driven narrative objectives
   * Includes hooks, conflicts, success criteria

2. **`analyze_narrative_opportunities(scene_graph, character_state)`**

   * Extracts dramatic opportunities
   * Classifies as conflict, discovery, mystery, romance, etc.
   * Scores dramatic potential

### Architecture:

* FastMCP server
* Pydantic models for strict typing
* Docstring-level API reference
* JSON schemaâ€“validated outputs
* Graceful failure / fallback

---

## 4. Gemini Vision Client (`mcp_clients/gemini_vision.py`)

**Role:** Convert hand-drawn maps â†’ structured scene graphs
**Output Contains:**

* Locations
* Landmarks
* Characters
* Spatial relationships
* Terrain features

**Why judges care:**
Reliable scene understanding is a hard multimodal problem.

---

## 5. Modal GPU Map Generator (`modal_app/map_generator.py`)

**Role:** Generate high-quality fantasy maps
**Stack:**

* GPU: L40S
* Model: FLUX.1 or SDXL variant
* Input: scene graph
* Output: PNG bytes

**Fallback:** Produces â€œtemplate mapâ€ when GPU offline.

---

## 6. World State System (`core/world_state.py`)

Tracks:

* Locations
* Entities
* Relationships
* Quest history
* Last scene graph
* Player metadata

Purpose:

* Ensures continuity
* Supplies MCP tools with context
* Bridges multiple turns of the story

---

## 7. Story Pipeline (`core/pipeline.py`)

Defines the **full orchestration**:

1. Receive user message / image
2. Extract scene graph
3. Update world state
4. Call MCP tools
5. Generate story continuation
6. Generate map (async)
7. Combine outputs â†’ UI

---

## 8. Memory Store MCP Client (`mcp_clients/memory_store.py`)

Simple version (MVP):

* Dictionary-based
* In-memory storage
* Provides structured retrieval for Claude

Later upgrade (optional):

* LlamaIndex for semantic search

---

## 9. Optional ElevenLabs Narration (`services/narration.py`)

Converts story paragraphs â†’ audio clips.
**Judges love this as a finishing touch**, but itâ€™s not core.

---

# ğŸ§± Data Flow

### **User Input â†’ Scene Graph**

```
image.png 
    â†’ Gemini Vision 
        â†’ scene_graph.json
```

### **Scene Graph â†’ Narrative Engine MCP**

```
scene_graph + world_state 
    â†’ analyze_opportunities() 
    â†’ generate_objectives()
```

### **User Objective Choice â†’ Claude**

```
objective + history + memory 
    â†’ story_continuation
```

### **Scene Graph â†’ Modal Map Generator**

```
scene_graph 
    â†’ map_generator_gpu() 
    â†’ fantasy_map.png
```

### **Final Output**

```
{story_text, quest_options, map_image, audio(optional)}
```

---

# ğŸ›¡ï¸ Reliability Architecture (Winning Requirement)

### **Error Handling**

* Gemini failure â†’ fallback to text-only scene interpretation
* Modal GPU failure â†’ pre-cached placeholder map
* MCP server failure â†’ Claude-based objective generation
* Claude error â†’ retry â†’ summarize fallback

### **Timeout Controls**

* All external APIs wrapped with `asyncio.wait_for()`
* Max 30s GPU jobs
* Max 10s MCP inference

### **Structured Logging**

Each step logs:

```
{
  "component": "modal",
  "event": "map_generation",
  "latency_ms": 3200,
  "status": "success"
}
```

---

# ğŸ”— Integration Map (Sponsors)

| Sponsor                   | Usage                                               |
| ------------------------- | --------------------------------------------------- |
| **Anthropic**             | Story generation, tool orchestration, MCP reasoning |
| **Google**                | Gemini Vision for scene graphs                      |
| **Modal**                 | GPU diffusion for map generation                    |
| **HuggingFace**           | Deployment of Gradio app                            |
| **ElevenLabs** (optional) | Audio narration                                     |
| **Flux/SDXL**             | High-res map models                                 |

---

# ğŸ§ª Testing Strategy

### Unit Tests

* MCP server tool outputs
* Scene graph validation
* WorldState update logic
* Pipeline branching and fallbacks

### Integration Tests

* Full pipeline run:

  1. messy image â†’ scene graph
  2. narrative engine â†’ objectives
  3. map generation
  4. story continuation

### Stress Tests

* Repeated tool calls
* Large context windows
* Multiple quest loops

---

# ğŸ“¦ Packaging & Deployment

### HF Spaces

* CPU-only fallback mode
* Secrets injected
* Modal used externally
* Local caching for speed

### CLI Demo

* Proven reusable MCP server
* Minimal dependencies
* Works without Gradio

---

# ğŸ Architecture Summary

MythWeaver is designed with:

* **Reusability** (core MCP engine)
* **Reliability** (fallbacks, retries, structured logs)
* **Multimodal AI** (vision â†’ scene â†’ narrative â†’ maps)
* **Agentic orchestration** (Claude selects tools)
* **Judge-focused clarity** (clean diagrams + typed schemas)
